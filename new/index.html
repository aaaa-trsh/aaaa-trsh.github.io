<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Cool cell stuff</title>
    <link rel="stylesheet" href="./style.css">
    <script src="perlin.js"></script>

</head>
    <body>
        <canvas id="canvas"></canvas>
        <script>
            const canvas = document.getElementById("canvas")
            const ctx = canvas.getContext('2d', { alpha: false });

            var scale = new Image();
            scale.src = "./scale-inferno.png";
            scale.setAttribute('crossOrigin', '');

            const scaleCtx = document.createElement("CANVAS").getContext('2d')
            scale.onload = function() {
                window.addEventListener('resize', resizeCanvas);
                resizeCanvas();
                scaleCtx.drawImage(scale, 0, 0);

                update();
            };
            
            const cellSize = 8;//B3/S123
            const survive = [1, 2, 3, 4];
            const birth = [3];

            var darkTone = "#1E0B46"//"#00000000"
            var midTone = "#ffffff"//"#6F186D" //"#073d1c"
            var lightTone = "#FBB118" //"#06a142"
                                
            var map = Array.from(Array(2), () => new Array(4));
            var prevMap;

            function resizeCanvas() {
                canvas.width  = window.innerWidth;
                canvas.height = window.innerHeight;
                scaleMap(Math.ceil(canvas.width/cellSize), Math.ceil(canvas.height/cellSize));
            }
            
            function lerpColor(a, b, amount) { 
                var ah = parseInt(a.replace(/#/g, ''), 16),
                    ar = ah >> 16, ag = ah >> 8 & 0xff, ab = ah & 0xff,
                    bh = parseInt(b.replace(/#/g, ''), 16),
                    br = bh >> 16, bg = bh >> 8 & 0xff, bb = bh & 0xff,
                    rr = ar + amount * (br - ar),
                    rg = ag + amount * (bg - ag),
                    rb = ab + amount * (bb - ab);

                return '#' + ((1 << 24) + (rr << 16) + (rg << 8) + rb | 0).toString(16).slice(1);
            }
            
            function componentToHex(c) {
                var hex = c.toString(16);
                return hex.length == 1 ? "0" + hex : hex;
            }

            function rgbToHex(r, g, b) {
                return "#" + componentToHex(r) + componentToHex(g) + componentToHex(b);
            }

            function sampleScale(x) {
                x = Math.round(Math.min(Math.max(x, 0.01), 0.99) * 100)
                var imData = scaleCtx.getImageData(x, 0, 1, 1).data;
                //var str = rgbToHex(imData[0], imData[1], imData[2])
                return [imData[0], imData[1], imData[2]]
            }

            function randomColor() {
                return Math.floor(Math.random()*16777215).toString(16);
            }

            function getScore(x, y) {
                return x < map[0].length && x > -1 && y < map.length && y > -1 ? Math.sign(map[y][x]) : 0
            }
            function cellularAutomata() {
                //var newMap = map
                //var prevMap = JSON.parse(JSON.stringify(map));
                var prevMap = map.map(function(arr) {
                    return arr.slice();
                });
                for (var y = 0; y < map.length; y++)
                {
                    for (var x = 0; x < map[y].length; x++)
                    {
                        var score = getScore(x-1, y+1)+getScore(x, y+1)+getScore(x+1, y+1)+getScore(x-1, y)+getScore(x+1, y)+getScore(x-1, y-1)+getScore(x, y-1)+getScore(x+1, y-1);
                        //score = score.toString()
                        if (birth.includes(score)) {
                            map[y][x] = 1;
                        }else if (!survive.includes(score)) {
                            map[y][x] = 0;
                        }
                        if (map[y][x] > 0.1) {
                            map[y][x] -= 0.1
                        }
                        if (prevMap[y][x] == 0 && map[y][x] > 0 ) {
                            map[y][x] = 2;
                        }
                        //if (map[y][x] > 0.2 && map[y][x] < 1 && prevMap[y][x] > 0 && prevMap[y][x] < 1) {
                        //    map[y][x] -= 0.1;
                        //}

                        
                        //map[y][x] = map[y][x] > 0 ? map[y][x]-0.05 : (map[y][x] > 1 ? map[y][x]-0.3 : map[y][x])

                        if (Math.random() > 0.9999){ map[y][x] = 0.1; }

                        
                        //ctx.fillStyle = map[y][x] == 0 ? "black" : (map[y][x] > 1 ? "white" : "#212121");
                        //ctx.fillStyle = map[y][x] == 0 ? "black" : (map[y][x] > 1 ? lerpColor(midTone, lightTone, (map[y][x]-1)): lerpColor(darkTone,midTone, map[y][x]));
                        var celCol = sampleScale(map[y][x]/2)
                        ctx.fillStyle = `rgba(${celCol[0]}, ${celCol[1]}, ${celCol[2]})`
                        ctx.fillRect(x*cellSize, y*cellSize, cellSize, cellSize);
                    }
                }
                return map
            }

            function randomize() {
                noise.seed(Math.random())
                for (var y = 0; y < map.length; y++)
                {
                    for (var x = 0; x < map[0].length; x++)
                    {
                        if ((noise.simplex2(x/50, y/50)+1)/2 > 0.1) {
                            map[y][x] = 0;
                        }
                    }
                }
            }

            function scaleMap(newSizeX, newSizeY) {
                map = Array.from(Array(newSizeY), () => new Array(newSizeX).fill(1))
                randomize();
            }

            var i = 0;
            function update() {
                //var t0 = performance.now()
                map = cellularAutomata();
                i++;
                //var t1 = performance.now()
                //console.log("Call to cellularAutomata took " + (t1 - t0) + " milliseconds.")
                
                if (i == 210) {
                    randomize()
                    i = 0;
                }
                setInterval(()=>{
                    window.requestAnimationFrame(update);
                }, 1000/20);
            }
        </script>
    </body>
</html>